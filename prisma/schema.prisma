// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}
// Add these enums (typically after your existing enums like Status, Role, etc.)
enum NotificationAction {
  ADDED
  SIGNED_IN
  DELETED
  UPDATED
}

enum NotificationTarget {
  USER_PROFILE
  EMAIL
  SUPERVISOR
  SUPERADMIN
  GUARD
  COMMENT
}
// Enums
enum Role {
  SUPER_ADMIN
  ADMIN
  SUPERVISOR
  GUARD
}

enum RecordStatus {
  LIVE
  UPDATED
  ARCHIVED
  DRAFT
}

enum LogType {
  INCIDENT
  PATROL
  VISITOR_CHECKIN
  MAINTENANCE
  WEATHER
  ON_DUTY_CHECKLIST
  OTHER
}

enum IncidentSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AssetType {
  BOAT
  VEHICLE
  EQUIPMENT
  FACILITY
  OTHER
}

enum AssetStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  DAMAGED
}

enum EquipmentStatus {
  AVAILABLE
  CHECKED_OUT
  MAINTENANCE
  LOST
  DAMAGED
}

enum MaintenanceStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MaintenancePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum AlertPriority {
  INFO
  WARNING
  CRITICAL
}

// Models
model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  username  String?   @unique
  firstName String
  lastName  String
  imageUrl  String?
  phone     String?
  streetAddress   String?
  city            String?
  state           String?
  zipCode         String?
  role      Role     @default(GUARD)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  logs                      Log[]
  reviewedLogs              Log[]                     @relation("ReviewedLogs")
  dutySessions              DutySession[]
  locationCheckIns          LocationCheckIn[]
  shiftAssignments          ShiftAssignment[]         // Shifts assigned to this user
  recurringUserAssignments  RecurringUserAssignment[] // Recurring patterns assigned to this user
  safetyChecklistResponses  SafetyChecklistResponse[]

  @@index([username])
  @@index([clerkId])
  @@index([email])
}

model Location {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  address     String?
  isActive    Boolean  @default(true)
  maxCapacity Int?     // Optional: Maximum number of guards that can be assigned per shift

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  logs                     Log[]
  shifts                   Shift[]
  dutySessions             DutySession[]
  locationCheckIns         LocationCheckIn[]
  recurringShiftPatterns   RecurringShiftPattern[]
  assets                   Asset[]
  visitors                 Visitor[]
  equipment                Equipment[]
  maintenanceRequests      MaintenanceRequest[]
  alerts                   Alert[]
  safetyChecklistResponses SafetyChecklistResponse[]

  @@index([name])
}

model Shift {
  id                    String   @id @default(cuid())
  name                  String
  startTime             DateTime
  endTime               DateTime
  locationId            String
  recurringPatternId    String?  // Link to recurring pattern if this shift was generated from one

  location              Location @relation(fields: [locationId], references: [id])
  recurringPattern      RecurringShiftPattern? @relation(fields: [recurringPatternId], references: [id])

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  logs                  Log[]
  dutySessions          DutySession[]
  assignments           ShiftAssignment[] // Multiple users can be assigned

  @@index([locationId])
  @@index([recurringPatternId])
  @@index([startTime, endTime])
}

// Many-to-many relationship between Shifts and Users
model ShiftAssignment {
  id          String   @id @default(cuid())
  shiftId     String
  userId      String
  role        String?  // Optional: "PRIMARY", "BACKUP", "SUPERVISOR" etc.

  shift       Shift    @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([shiftId, userId]) // Prevent duplicate assignments
  @@index([shiftId])
  @@index([userId])
}

// Recurring shift patterns (e.g., "Every Monday 7am-3pm at Location X")
model RecurringShiftPattern {
  id              String   @id @default(cuid())
  name            String
  locationId      String
  startTime       String   // Time only, e.g., "07:00"
  endTime         String   // Time only, e.g., "15:00"
  daysOfWeek      String   // JSON array: [1,3,5] for Mon, Wed, Fri (0=Sunday, 6=Saturday)
  isActive        Boolean  @default(true)

  // Pattern validity period
  startDate       DateTime
  endDate         DateTime? // Null = indefinite

  location        Location @relation(fields: [locationId], references: [id])
  shifts          Shift[]  // Shifts generated from this pattern
  userAssignments RecurringUserAssignment[] // Default users for this pattern

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([locationId])
  @@index([isActive])
}

// Default user assignments for recurring patterns
model RecurringUserAssignment {
  id                    String                @id @default(cuid())
  recurringPatternId    String
  userId                String
  role                  String?               // Optional: "PRIMARY", "BACKUP", etc.

  recurringPattern      RecurringShiftPattern @relation(fields: [recurringPatternId], references: [id], onDelete: Cascade)
  user                  User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  @@unique([recurringPatternId, userId])
  @@index([recurringPatternId])
  @@index([userId])
}

model Log {
  id            String       @id @default(cuid())
  type          LogType
  title         String
  description   String       @db.Text
  status        RecordStatus @default(LIVE)

  locationId    String
  shiftId       String?
  userId        String

  // Incident Report Specific Fields
  severity           IncidentSeverity?
  incidentTime       DateTime?         // Actual time of incident (vs createdAt = when reported)
  peopleInvolved     String?           @db.Text  // Names, descriptions
  witnesses          String?           @db.Text  // Witness information
  actionsTaken       String?           @db.Text  // What the guard did
  followUpRequired   Boolean?          @default(false)
  followUpNotes      String?           @db.Text
  weatherConditions  String?
  photoUrls          String?           @db.Text  // JSON array of photo URLs
  videoUrls          String?           @db.Text  // JSON array of video URLs
  reviewedBy         String?           // Supervisor who reviewed (for incidents)
  reviewedAt         DateTime?         // When reviewed
  reviewNotes        String?           @db.Text  // Supervisor notes

  location                Location                 @relation(fields: [locationId], references: [id])
  shift                   Shift?                   @relation(fields: [shiftId], references: [id])
  user                    User                     @relation(fields: [userId], references: [id])
  reviewer                User?                    @relation("ReviewedLogs", fields: [reviewedBy], references: [id])
  safetyChecklistResponse SafetyChecklistResponse?

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  archivedAt    DateTime?

  @@index([locationId])
  @@index([shiftId])
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([severity])
  @@index([reviewedBy])
}

model DutySession {
  id          String    @id @default(cuid())
  userId      String
  locationId  String?   // Null for supervisors (roaming duty)
  shiftId     String?   // Optional link to scheduled shift

  clockInTime  DateTime @default(now())
  clockOutTime DateTime? // Null = still on duty

  notes       String?   @db.Text // End of shift notes

  user        User      @relation(fields: [userId], references: [id])
  location    Location? @relation(fields: [locationId], references: [id])
  shift       Shift?    @relation(fields: [shiftId], references: [id])

  // Supervisor location check-ins during this duty session
  locationCheckIns         LocationCheckIn[]
  safetyChecklistResponses SafetyChecklistResponse[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([locationId])
  @@index([clockInTime])
  @@index([clockOutTime])
}

model LocationCheckIn {
  id             String       @id @default(cuid())
  dutySessionId  String       // Link to supervisor's duty session
  locationId     String
  userId         String       // Supervisor who checked in

  checkInTime    DateTime     @default(now())
  notes          String?      @db.Text // Observations at this location

  dutySession    DutySession  @relation(fields: [dutySessionId], references: [id], onDelete: Cascade)
  location       Location     @relation(fields: [locationId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([dutySessionId])
  @@index([locationId])
  @@index([userId])
  @@index([checkInTime])
}

// Add this model (typically after your existing models)
model Notification {
  id        String             @id @default(cuid())
  user      String
  action    NotificationAction
  target    NotificationTarget
  message   String?
  unread    Boolean            @default(true)
  createdAt DateTime           @default(now())
  updateAt DateTime            @updatedAt

  @@index([user])
  @@index([unread])
  @@map("notifications")
}

// Asset Management - Track boats, vehicles, equipment at marinas
model Asset {
  id          String      @id @default(cuid())
  name        String
  type        AssetType
  status      AssetStatus @default(ACTIVE)
  description String?     @db.Text

  // Asset details
  make        String?
  model       String?
  year        Int?
  serialNumber String?    @unique
  registrationNumber String?

  // Location tracking
  locationId  String?
  location    Location?   @relation(fields: [locationId], references: [id])

  // Ownership/Assignment
  assignedTo  String?     // User ID if assigned to a person

  // Value and insurance
  purchaseDate DateTime?
  purchasePrice Decimal?  @db.Decimal(10, 2)
  insuranceInfo String?   @db.Text

  // Maintenance tracking
  lastMaintenanceDate DateTime?
  nextMaintenanceDate DateTime?
  maintenanceNotes    String?   @db.Text

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([locationId])
  @@index([type])
  @@index([status])
  @@index([serialNumber])
}

// Visitor tracking
model Visitor {
  id            String    @id @default(cuid())
  firstName     String
  lastName      String
  email         String?
  phone         String?
  company       String?
  purpose       String?   @db.Text

  // Visit details
  locationId    String
  location      Location  @relation(fields: [locationId], references: [id])

  checkInTime   DateTime  @default(now())
  checkOutTime  DateTime?
  expectedDuration Int?    // Minutes

  // Logged by
  checkedInBy   String
  checkedOutBy  String?

  // Vehicle info
  vehicleMake   String?
  vehicleModel  String?
  licensePlate  String?

  // Badge/Pass
  badgeNumber   String?

  notes         String?   @db.Text

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([locationId])
  @@index([checkInTime])
  @@index([email])
  @@index([licensePlate])
}

// Security equipment check-out system
model Equipment {
  id              String          @id @default(cuid())
  name            String
  description     String?
  serialNumber    String?         @unique
  status          EquipmentStatus @default(AVAILABLE)

  // Location
  locationId      String?
  location        Location?       @relation(fields: [locationId], references: [id])

  // Current checkout (if any)
  checkedOutTo    String?         // User ID
  checkedOutAt    DateTime?
  expectedReturnAt DateTime?

  // Maintenance
  lastMaintenance DateTime?
  nextMaintenance DateTime?

  notes           String?         @db.Text

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([locationId])
  @@index([status])
  @@index([checkedOutTo])
}

// Maintenance request tracking
model MaintenanceRequest {
  id            String              @id @default(cuid())
  title         String
  description   String              @db.Text
  priority      MaintenancePriority @default(MEDIUM)
  status        MaintenanceStatus   @default(PENDING)

  // Location
  locationId    String
  location      Location            @relation(fields: [locationId], references: [id])

  // Reported by
  reportedBy    String              // User ID
  reportedAt    DateTime            @default(now())

  // Assignment
  assignedTo    String?             // User ID or maintenance team
  assignedAt    DateTime?

  // Completion
  completedBy   String?
  completedAt   DateTime?
  resolution    String?             @db.Text

  // Cost tracking
  estimatedCost Decimal?            @db.Decimal(10, 2)
  actualCost    Decimal?            @db.Decimal(10, 2)

  // Photos
  photoUrls     String?             @db.Text  // JSON array

  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@index([locationId])
  @@index([status])
  @@index([priority])
  @@index([reportedBy])
  @@index([assignedTo])
}

// System alerts for guards
model Alert {
  id          String        @id @default(cuid())
  title       String
  message     String        @db.Text
  priority    AlertPriority @default(INFO)

  // Targeting
  locationId  String?       // Null = all locations
  location    Location?     @relation(fields: [locationId], references: [id])

  targetRole  Role?         // Null = all roles, or specific role

  // Validity period
  activeFrom  DateTime      @default(now())
  activeUntil DateTime?

  // Acknowledgment tracking
  acknowledgedBy String?     @db.Text  // JSON array of user IDs

  // Created by
  createdBy   String        // User ID (admin/supervisor)

  isActive    Boolean       @default(true)

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([locationId])
  @@index([priority])
  @@index([isActive])
  @@index([activeFrom, activeUntil])
}

// Safety Equipment Checklist - Master list of items to check
model SafetyChecklistItem {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?  @db.Text
  order       Int      @default(0) // Display order
  isActive    Boolean  @default(true)

  // Relation to individual checks
  checks      SafetyChecklistItemCheck[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([order])
}

// Safety Checklist Response - Completed checklist by a guard
model SafetyChecklistResponse {
  id             String    @id @default(cuid())
  dutySessionId  String    // Which duty session this checklist is for
  userId         String    // Guard who completed it
  locationId     String    // Location where checklist was completed
  logId          String?   @unique // Link to auto-created log entry

  completedAt    DateTime  @default(now())

  // Relations
  dutySession    DutySession @relation(fields: [dutySessionId], references: [id], onDelete: Cascade)
  user           User        @relation(fields: [userId], references: [id])
  location       Location    @relation(fields: [locationId], references: [id])
  log            Log?        @relation(fields: [logId], references: [id])
  itemChecks     SafetyChecklistItemCheck[]

  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([dutySessionId])
  @@index([userId])
  @@index([locationId])
  @@index([completedAt])
}

// Individual item check within a checklist response
model SafetyChecklistItemCheck {
  id                        String   @id @default(cuid())
  safetyChecklistResponseId String
  safetyChecklistItemId     String

  checked                   Boolean  @default(false)
  notes                     String?  @db.Text // Optional notes if issue found

  // Relations
  response                  SafetyChecklistResponse @relation(fields: [safetyChecklistResponseId], references: [id], onDelete: Cascade)
  item                      SafetyChecklistItem     @relation(fields: [safetyChecklistItemId], references: [id])

  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@unique([safetyChecklistResponseId, safetyChecklistItemId])
  @@index([safetyChecklistResponseId])
  @@index([safetyChecklistItemId])
}
